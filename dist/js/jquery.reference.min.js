/*! Reference - v0.1alpha - 2012-07-05
* https://github.com/mike-marcacci/Reference
* Copyright (c) 2012 Mike Marcacci; Licensed MIT, GPL */
(function(a){"use strict",a.extend({referenceCollections:[]}),a.extend({addReferenceCollection:function(b){b=a.extend({title:"",caseSensitive:!1,data:null,type:null,ajax:null,cache:!0,keys:null,custom:null},b);if(b.type===null)if(b.data)b.type="data";else if(b.ajax)b.type="ajax";else if(b.custom)b.type="custom";else return!1;b.type==="data"&&!b.caseSensitive&&a.each(b.data,function(a,c){b.data[a.toUpperCase()]=c,delete b.data[a]}),b.type==="data"&&(!b.keys||b.keys.length===0)&&(b.keys=[],a.each(b.data,function(a,c){b.keys.push(a)}));if(b.type==="ajax")var c=0;return b.id=a.referenceCollections.push(b)-1,b}})})(jQuery),function(a){"use strict",a.extend({addReferences:function(b,c,d,e){var f,g;if(b.nodeType===3){f=b.data.match(c);if(f){g=document.createElement("span");var h=b.splitText(f.index);h.splitText(f[0].length);var i=h.cloneNode(!0);g.appendChild(i),h.parentNode.replaceChild(g,h),g=a(g),g.addClass("reference-link "+e.theme).addClass("on-"+d);var j={};return j[d]=e,g.data("referenceTriggers",a.extend(!0,{},j)),1}}else if(a(b).hasClass("reference-link")&&a(b).data("referenceTriggers"))f=a(b).text().match(c),f&&(g=a(b),g.data("referenceTriggers")[d]?(g.data("referenceTriggers")[d].collections.push(e.collections[0]),g.data("referenceTriggers")[d].theme=e.theme):g.data("referenceTriggers")[d]=a.extend(!0,{},e));else if(b.nodeType===1&&b.childNodes&&!/(script|style)/i.test(b.tagName))for(var k=0;k<b.childNodes.length;k++)k+=a.addReferences(b.childNodes[k],c,d,e);return 0}}),a.fn.addReferences=function(b){var c=a(this),d={collections:[],trigger:"click",theme:"apple",exactMatch:!0};a.extend(d,b),a.each(d.collections,function(b,e){var f;a.inArray(e,a.referenceCollections)===-1?f=a.addReferenceCollection(e):f=e;var g=f.keys;g=jQuery.map(g,function(a,b){return a.charAt(0)==="/"&&a.charAt(a.length-1)==="/"?a.substr(1,a.length-2):a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")});var h="("+g.join("|")+")";d.exactMatch&&(h="\\b"+h+"\\b");var i=new RegExp(h,f.caseSensitive?"":"i"),j={theme:d.theme,collections:[f.id]};c.each(function(){jQuery.addReferences(this,i,d.trigger,j)})});var e=!1;return c.data("events")&&c.data("events")[d.trigger]&&a.each(c.data("events")[d.trigger],function(a){this.selector===".reference-link.on-"+d.trigger&&(e=!0)}),e||(c.on(d.trigger,".reference-link.on-"+d.trigger,a.fn.reference),a(document).on(d.trigger,a.fn.closeReferences)),a(this)},a.fn.removeReferences=function(b){return a(this)}}(jQuery),function(a){"use strict",a.extend({reference:function(b,c){b=a(b);var d=b.data("referenceTriggers")[c.type],e=b.text();b.addClass("reference-link-active");var f=a('<div id="reference-bubble" class="apple"><div class="reference-bubble-arrow"></div></div>').appendTo(b);f.offset().top+parseInt(f.css("max-height"),10)+(f.outerHeight()-f.height())>a(window).height()?f.addClass("up"):f.addClass("down");var g=10,h;f.offset().left<0?(h=0-f.offset().left+g,f.css("margin-left",parseInt(f.css("margin-left"),10)+h+"px"),a(".reference-bubble-arrow",f).css("margin-left",parseInt(a(".reference-bubble-arrow",f).css("margin-left"),10)-h+"px")):f.offset().left+f.outerWidth()>a(window).width()&&(h=0-(f.offset().left+f.outerWidth()-a(window).width())-g,f.css("margin-left",parseInt(f.css("margin-left"),10)+h+"px"),a(".reference-bubble-arrow",f).css("margin-left",parseInt(a(".reference-bubble-arrow",f).css("margin-left"),10)-h+"px")),a.each(d.collections,function(b,c){var d=a.referenceCollections[c],g=d.caseSensitive?e:e.toUpperCase(),h,i;d.type==="data"?h=d.data[g]:d.type==="ajax"?i=0:d.type==="custom"&&(i=0),f.append('<div class="reference-collection-name"><div style="display:none;" class="reference-loading-spinner"><span class="reference-loading-top"></span><span class="reference-loading-left"></span><span class="reference-loading-bottom"></span><span class="reference-loading-right"></span></div>'+d.title+"</div>"),f.append('<div class="reference-collection-result">'+h+"</div>")})}}),a.fn.reference=function(b){return a(b.delegateTarget).closeReferences(),a.reference(this,b),b.stopPropagation(),a(this)},a.fn.closeReferences=function(b){return a(".reference-link-active").removeClass("reference-link-active"),a("#reference-bubble").remove(),a(this)},a(window).on("resize",function(){a(document).closeReferences()})}(jQuery);